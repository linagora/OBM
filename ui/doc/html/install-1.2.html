<html>
<head>
<title>Basic steps to build and install OBM 1.2.x</title>
</head>
<!-- $Id$ -->
<body bgcolor="#FFFFFF">

<a href="javascript:back();">back</a>

<p />These docs are valid for OBM 1.2.x

Only specific OBM steps are described. To know how to install apache, php, mysql or others components, look in your distribution manuals.

<h1>Basic steps to build and install OBM 1.2..x</h1>

<h2> Assumptions</h2>

We suppose apache, php and a database server (mysql or postgres) are correctly installed and functionnal.
<br>
For pre-packaged distributions, check in your distribution docs.
<br>
In Debian, install php4, php4-cgi, php4-mysql or php4-pgsql, apache, apache-common

<p />
We suppose that as an example the obm root is /var/www/obm
<p />


<h2>1: Get the source</H2>
Would be more difficult without it.
<br />
And uncompress it in /var/www (or where your document root will be located).
<table bgcolor="#CCCCCC" border="1">
<tr>
  <td><pre>
wget http://obm.aliacom.fr/obm-archives/obm-1.2.0.tar.gz
tar -C /var/www -xzvf obm-1.2.0.tar.gz
cd /var/www
ln -s obm-1.2.0 obm
</pre>
  </td>
</tr>
</table>
<p>

Set the correct files owner to the OBM sources (needed for safe_mode On, in documents)
<table bgcolor="#CCCCCC" border="1">
<tr>
  <td><pre>
cd /var/www/obm
chown -R www-data:www-data *  (on Debian)
chown -R apache:apache *  (on Redhat)
</pre>
  </td>
</tr>
</table>


<h2>2: PHP (module and command line configuration)</h2>

PHP apache module config file : on Debian : /etc/php/apache/php.ini, on RedHat /etc/php.ini.
<br />Command line PHP must be configured too (Some tools (install script, admin tools) works or are also available with php in command line mode (php-cli).) (on Debian : /etc/php4/cgi/php.ini, ot /etc/php4/cli/php.ini on recent versions)
<p />
The include_path directive must be set :

<table bgcolor="#CCCCCC" border="1">
<tr>
  <td><pre>
include_path = ".:/php/includes:/var/www/obm"
</pre>
  </td>
</tr>
</table>
<p>

short_open_tag can be set to Off :

<table bgcolor="#CCCCCC" border="1">
<tr>
  <td><pre>
short_open_tag = On (can be switched to Off since OBM 0.7.3)
</pre>
  </td>
</tr>
</table>
<p>

Globals must be registered automatically :
<table bgcolor="#CCCCCC" border="1">
<tr>
  <td><pre>
register_globals = On
</pre>
  </td>
</tr>
</table>
<p>

Magic quotes must be On :
<table bgcolor="#CCCCCC" border="1">
<tr>
  <td><pre>
magic_quotes_gpc = On
</pre>
  </td>
</tr>
</table>
<p>

and depending on obm file's owner (of course works well with safe_mode turne Off too !):
<table bgcolor="#CCCCCC" border="1">
<tr>
  <td><pre>
safe_mode = On
</pre>
  </td>
</tr>
</table>

<h3>2.1: Check that php support mysql or postgresql</h3>
Depending on your database engine, one of these lines must be present in your php.ini (both module and command line if they are separated) :
<table bgcolor="#CCCCCC" border="1">
<tr>
  <td><pre>
extension=mysql.so
extension=pgsql.so
</pre>
  </td>
</tr>
</table>



<h2>3: Apache and PHP configuration</h2>

OBM sources are in the php directory.
Included files are in the obminclude directory.
<p />
For the OBM web application, all the apache and php configuration is done through the apache <b>httpd.conf</b> file.


<h3>Configure apache to process PHP files</h3>
Edit your httpd.conf or srm.conf file and add:
<table bgcolor="#CCCCCC" border="1">
<tr>
  <td><pre>
    AddType application/x-httpd-php .php
</pre>
  </td>
</tr>
</table>
<p>
On RedHat 8 with apache2, chech that your /etc/httpd/conf.d/php.conf is correct

<p />
We set up a virtual host to handle one occurence of OBM (there can be several on one server).
In the virtual host section set :

<h3>Document root</h3>
Set your document root to : /var/www/obm/php
<table bgcolor="#CCCCCC" border="1">
<tr>
  <td><pre>
    DocumentRoot /var/www/obm/php
</pre>
  </td>
</tr>
</table>


<h3>OBM include directory</h3>

The name obminclude is now a variable to allow multiple OBM instances on the same code source base (only obminclude will differ which give different database, themes, langs... for each instances). This variable is set through an environment variable in the apache httpd.conf file.
<p />
load the env module
<table bgcolor="#CCCCCC" border="1">
<tr>
  <td><pre>
    LoadModule env_module /usr/lib/apache/1.3/mod_env.so (apache 1.3 on Debian)
    LoadModule env_module modules/mod_env.so (apache 2 on Redhat)
</pre>
  </td>
</tr>
</table>

<br>fill the OBM_INCLUDE_VAR with the name of the obminclude dir
<table bgcolor="#CCCCCC" border="1">
<tr>
  <td><pre>
    Setenv OBM_INCLUDE_VAR obminclude
</pre>
  </td>
</tr>
</table>

<p />
The path to php include files must be given.
As a side note, the obminclude directory can be moved to another location.
<p />
fill the php include_path with the location of the obminclude
<table bgcolor="#CCCCCC" border="1">
<tr>
  <td><pre>
    php_value include_path ".:/var/www/obm"
</pre>
  </td>
</tr>
</table>


<h3>Images alias</h3>
# Set an alias to images in the themes directory:
<table bgcolor="#CCCCCC" border="1">
<tr>
  <td><pre>
    Alias /images /var/www/obm/obminclude/themes
</pre>
  </td>
</tr>
</table>


<h3>Directory Index</h3>
Set the directory index to obm.php
<table bgcolor="#CCCCCC" border="1">
<tr>
  <td><pre>
    DirectoryIndex obm.php
</pre>
  </td>
</tr>
</table>


<p />
We <b>strongly</b> recommend to prevent direct access to .inc files
<table bgcolor="#CCCCCC" border="1">
<tr>
  <td><pre>
&lt;Files ~ "\.inc$">
  Order allow,deny
  Deny from all
&lt;/Files>
</pre>
  </td>
</tr>
</table>


<h3>Complete virtual host block example</h3>

Be sure that your ip is defined as a named virtual host and enter this block
<table bgcolor="#CCCCCC" border="1">
<tr>
  <td><pre>
NameVirtualHost 127.0.0.1

&lt;VirtualHost 192.168.1.5>
    ServerAdmin root@localhost
    DocumentRoot /var/www/obm/php
    ServerName obm-panthere
    ErrorLog /var/log/apache/obm-error.log
    CustomLog /var/log/apache/obm-access.log common
    SetEnv OBM_INCLUDE_VAR obminclude
    Alias /images /var/www/obm/obminclude/themes
    DirectoryIndex obm.php
&lt;/VirtualHost>
</pre>
  </td>
</tr>
</table>


<h2>4: OBM configuration</h2>

The obm configuration is all located in the <i>obm_conf.inc</i> file.
<br />
# in obminclude copy the file <i>obm_conf.inc.sample</i> to your conf file <i>obm_conf.inc</i> and edit it.


<h3>4.1: Configure the OBM database</h3>

Sselect the database engine to use, declare the database, the database user and password.
Fill in your apache host name too.
You can update some global preferences in this file too (eg: cgp_mail_enabled)

<table bgcolor="#CCCCCC" border="1">
<tr>
  <td><pre>
// Database infos
$obmdb_host = "localhost";
$obmdb_dbtype = "MYSQL"; // (MYSQL || PGSQL)
$obmdb_db = "obm";
$obmdb_user = "obm";
$obmdb_password = "obm";

// OBM host
$cgp_host = "http://obm/";
 ...

// is Mail enabled ? (agenda)
$gp_mail_enabled = false;
</pre>
  </td>
</tr>
</table>


<h3>4.2: Document repository</h3>

Since OBM 1.2.0, the document repository is automatically handled by OBM.
In the install step OBM populate the repository configured with some structured directories for internal storage.
<br />
Declare your document repository
<table bgcolor="#CCCCCC" border="1">
<tr>
  <td><pre>
// Document : Root of the document repository
$cdocument_root = "/var/www/obmdocuments";
</pre>
  </td>
</tr>
</table>

<br />
Make sure this directory is writable by the apache process
<table bgcolor="#CCCCCC" border="1">
<tr>
  <td><pre>
$ chown www-data:www-data /var/www/obmdocuments
or
$ chmod a+rwx /var/www/obmdocuments
</pre>
  </td>
</tr>
</table>


<h3>4.3: Database Configuration and Creation</h3>
The scripts are in the scripts/1.2 directory.

<h4>4.3.1: Default Data language</h4>

Some references values are inserted by default. These values can be in french (by default) or in english.
To toggle these to english for installation edit the file scripts/1.2/install_obmdb_1.2.mysql.sh (pr pgsql) and change the DATA_LANG value to en :

<table bgcolor="#CCCCCC" border="1">
<tr>
  <td><pre>
# Mysql User, Password and Data lang var definition
U=obm
P="obm"
DB="obm"
DATA_LANG="en"
</pre>
  </td>
</tr>
</table>


<h4>4.3.2: MySQL</h4>

Requisite :</b> you must know (or create) a valid mysql login/password

<p />
mysql user creation example (user obm / obm)
<table bgcolor="#CCCCCC" border="1">
<tr>
  <td><pre>
GRANT CREATE, DROP, SELECT, UPDATE, INSERT, DELETE, LOCK TABLES, INDEX ON obm.* TO obm@localhost IDENTIFIED BY 'obm';
(or simpler GRANT ALL ON obm.* TO obm@localhost IDENTIFIED BY 'obm';)
</pre>
  </td>
</tr>
</table>
<p />

The script <i>install_obmdb_1.2.mysql.sh</i> handle all the database creation steps.
<br>
Set the correct User / password (or DB) in this script and run it
<table bgcolor="#CCCCCC" border="1">
<tr>
  <td><pre>
cd obm/scripts/1.2
emacs /install_obmdb_1.2.mysql.sh
./install_obmdb_1.2.mysql.sh
</pre>
  </td>
</tr>
</table>


<h4>4.3.3: PostgreSQL</h4>

Create the obm user and create the obm database :
<table bgcolor="#CCCCCC" border="1">
<tr>
  <td><pre>
create user obm password 'obm';
create database obm with owner = obm;
</pre>
  </td>
</tr>
</table>
<p />

<h5>4.3.3.1: Encoding</h5>
If your Postgres server is not configured with latin1 character set:
 edit the file scripts/1.2/postgres-pre.sql and uncomment the line (now uncommented by default)
<table bgcolor="#CCCCCC" border="1">
<tr>
  <td><pre>
\encoding latin1
</pre>
  </td>
</tr>
</table>

OBM should in the future be converted to UTF8 by default.
<p />

<h5>4.3.3.2: Install</h5>
The script <i>install_obmdb_1.2.pgsql.sh</i> handle all the database creation steps.
<br>
Edit User / password (or DB) infos in this script and run it
<table bgcolor="#CCCCCC" border="1">
<tr>
  <td><pre>
cd obm/scripts/1.2
emacs install_obmdb_1.2_pgsql.sh
./install_obmdb_1.2_pgsql.sh
</pre>
  </td>
</tr>
</table>


<h2>5: Run OBM (access the obm.php from your browser)</h2>
# First restart your apache web server

<table bgcolor="#CCCCCC" border="1">
<tr>
  <td><pre>
/etc/init.d/apache restart
</pre>
  </td>
</tr>
</table>

<p /># If all goes well run firefox (or others browsers) and launch the url
<br />yourvirtualhost/

<P># Log in with the uadmin/padmin account


<p/>
<a name="upgrade"><h1>UPGRADE from version 1.1.x to version 1.2.x</h1></a>

<h3>Update Database model</h3>
# MySQL
<table bgcolor="#CCCCCC" border="1">
<tr>
  <td><pre>
mysql -u obm -pobm obm < scripts/1.2/update-1.1-1.2.mysql.sql
</pre>
  </td>
</tr>
</table>
<p>
# Postgres
<table bgcolor="#CCCCCC" border="1">
<tr>
  <td><pre>
psql -U obm obm < scripts/1.2/update-1.1-1.2.pgsql.sql
</pre>
  </td>
</tr>
</table>


<h3>Insert new default preferences values</h3>
# MySQL
<table bgcolor="#CCCCCC" border="1">
<tr>
  <td><pre>
mysql -u obm -pobm obm < scripts/1.2/obmdb_default_values_1.2.sql
</pre>
  </td>
</tr>
</table>
<p>
# Postgres
<table bgcolor="#CCCCCC" border="1">
<tr>
  <td><pre>
psql -U obm obm < scripts/1.2/obmdb_default_values_1.2.sql
</pre>
  </td>
</tr>
</table>


<h3>Update sound signatures for contacts to allow sounding searches</h3>

# In OBM, from the ADMINISTRATION section (must be connected with an admin user), go to the <b>Data</b> module and execute the action <b>sound_aka_update</b> which update the sound signatures.



<p />
<a name="upgrade-common"><h1>UPGRADE COMMON ACTIONS</h1></a>

<h3>Option: Restore default display values for each user</h3>
# In OBM, from the ADMINISTRATION section (must be connected with an admin user), go to the <b>Prefs</b> (or Préférences) module and execute the action <b>user_pref_update</b> (which drop preferences for each user, hence leading to default)

<h3>Option: Insert NAF code values</h3>
A naf code dump is available (french naf codes). It has not been updated from 1.0 one. If you want to insert these reference data :
<br />
# MySQL Naf code data
<table bgcolor="#CCCCCC" border="1">
<tr>
  <td><pre>
mysql -u obm -pobm obm < scripts/1.2/data-fr/obmdb_nafcode_1.2.sql
</pre>
  </td>
</tr>
</table>

# Postgres Naf code data
<table bgcolor="#CCCCCC" border="1">
<tr>
  <td><pre>
psql -U obm obm < scripts/1.2/data-fr/obmdb_nafcode_1.2.sql
</pre>
  </td>
</tr>
</table>


<br /><br />
<a href="javascript:back();">back</a>


</body>
</html>
