<html>
<head>
<title>Basic steps to build and install OBM 0.8.x</title>
</head>
<!-- $Id$ -->
<body bgcolor="#FFFFFF">

<a href="javascript:back();">back</a>

<p />These docs are valid for OBM 0.8.0, 0.8.1, 0.8.2, 0.8.3, 0.8.4, 0.8.5, 0.8.6, 0.8.7.

Only specific OBM steps are described. To know how to install apache, php, mysql or others components, look in your distribution manuals.

<h1>Basic steps to build and install OBM 0.8.x</h1>

<h2> Assumptions</h2>

We suppose apache, php and a database server (mysql or postgres) are correctly installed and functionnal.
<br>
For pre-packaged distributions, check in your distribution docs.
<br>
In Debian, install php4, php4-cgi, php4-mysql or php4-pgsql, apache, apache-common

<p />
We suppose that as an example the obm root is /var/www/obm
<p />


<h2>1: Get the source</H2>
Would be more difficult without it.
<br />
And uncompress it in /var/www (or where your document root will be located).
<table bgcolor="#CCCCCC" border="1">
<tr>
  <td><pre>
wget http://obm.aliacom.fr/obm-archives/obm-0.8.7.tar.gz
tar -C /var/www -xzvf obm-0.8.7.tar.gz
cd /var/www
ln -s obm-0.8.7 obm
</pre>
  </td>
</tr>
</table>
<p>

Set the correct files owner to the OBM sources (needed for safe_mode On, in documents)
<table bgcolor="#CCCCCC" border="1">
<tr>
  <td><pre>
cd /var/www/obm
chown -R www-data:www-data *  (on Debian)
chown -R apache:apache *  (on Redhat)
</pre>
  </td>
</tr>
</table>


<h2>2: PHP (module and command line configuration)</h2>

PHP apache module config file : on Debian : /etc/php/apache/php.ini, on RedHat /etc/php.ini.
<br />Command line PHP must be configured too (Some tools (install script, admin tools) works or are also available with php in command line mode (php-cgi).) (on Debian : /etc/php4/cgi/php.ini, ot /etc/php4/cli/php.ini on recent versions it seems)
<p />
The include_path directive must be set :

<table bgcolor="#CCCCCC" border="1">
<tr>
  <td><pre>
include_path = ".:/php/includes:/var/www/obm"
</pre>
  </td>
</tr>
</table>
<p>

Since 0.7.3, the short_open_tag can be set to Off but must be On on version before 0.7.3:

<table bgcolor="#CCCCCC" border="1">
<tr>
  <td><pre>
short_open_tag = On (can be switched to Off since OBM 0.7.3)
</pre>
  </td>
</tr>
</table>
<p>

Globals must be registered automatically
<table bgcolor="#CCCCCC" border="1">
<tr>
  <td><pre>
register_globals = On
</pre>
  </td>
</tr>
</table>
<p>

Magic quotes must be On
<table bgcolor="#CCCCCC" border="1">
<tr>
  <td><pre>
magic_quotes_gpc = On
</pre>
  </td>
</tr>
</table>
<p>

and depending on obm file's owner (of course works well with safe_mode turne Off too !):
<table bgcolor="#CCCCCC" border="1">
<tr>
  <td><pre>
safe_mode = On
</pre>
  </td>
</tr>
</table>

<h3>2.1: Check that php support mysql or postgresql</h3>
Depending on your database engine, one of these lines must be present in your php.ini (both module and command line if they are separated) :
<table bgcolor="#CCCCCC" border="1">
<tr>
  <td><pre>
extension=mysql.so
extension=pgsql.so
</pre>
  </td>
</tr>
</table>



<h2>3: Apache and PHP configuration</h2>

OBM sources are in the php directory.
Included files are in the obminclude directory.
Since 0.5.2 obminclude is by default outside the document root for <b>security</b> reasons.
<p />
For the OBM web application, all the apache and php configuration is done through the apache <b>httpd.conf</b> file.


<h3>Configure apache to process PHP files</h3>
Edit your httpd.conf or srm.conf file and add:
<table bgcolor="#CCCCCC" border="1">
<tr>
  <td><pre>
    AddType application/x-httpd-php .php
</pre>
  </td>
</tr>
</table>
<p>
On RedHat 8 with apache2, chech that your /etc/httpd/conf.d/php.conf is correct

<p />
We set up a virtual host to handle one occurence of OBM (there can be several on one server).
In the virtual host section set :

<h3>Document root</h3>
Set your document root to : /var/www/obm/php
<table bgcolor="#CCCCCC" border="1">
<tr>
  <td><pre>
    DocumentRoot /var/www/obm/php
</pre>
  </td>
</tr>
</table>


<h3>OBM include directory</h3>

The name obminclude is now a variable to allow multiple OBM instances on the same code source base (only obminclude will differ which give different database, themes, langs... for each instances). This variable is set through an environment variable in the apache httpd.conf file.
<p />
load the env module
<table bgcolor="#CCCCCC" border="1">
<tr>
  <td><pre>
    LoadModule env_module /usr/lib/apache/1.3/mod_env.so (apache 1.3 on Debian)
    LoadModule env_module modules/mod_env.so (apache 2 on Redhat)
</pre>
  </td>
</tr>
</table>

<br>fill the OBM_INCLUDE_VAR with the name of the obminclude dir
<table bgcolor="#CCCCCC" border="1">
<tr>
  <td><pre>
    Setenv OBM_INCLUDE_VAR obminclude
</pre>
  </td>
</tr>
</table>

<p />
The path to php include files must be given.
As a side note, the obminclude directory can be moved to another location.
<p />
fill the php include_path with the location of the obminclude
<table bgcolor="#CCCCCC" border="1">
<tr>
  <td><pre>
    php_value include_path ".:/var/www/obm"
</pre>
  </td>
</tr>
</table>


<h3>Images alias</h3>
# Set an alias to images in the themes directory:
<table bgcolor="#CCCCCC" border="1">
<tr>
  <td><pre>
    Alias /images /var/www/obm/obminclude/themes
</pre>
  </td>
</tr>
</table>


<h3>Directory Index</h3>
Set the directory index to obm.php
<table bgcolor="#CCCCCC" border="1">
<tr>
  <td><pre>
    DirectoryIndex obm.php
</pre>
  </td>
</tr>
</table>


<p />
We <b>strongly</b> recommend to prevent direct access to .inc files
<table bgcolor="#CCCCCC" border="1">
<tr>
  <td><pre>
&lt;Files ~ "\.inc$">
  Order allow,deny
  Deny from all
&lt;/Files>
</pre>
  </td>
</tr>
</table>


<h3>Complete virtual host block example</h3>

Be sure that your ip is defined as a named virtual host and enter this block
<table bgcolor="#CCCCCC" border="1">
<tr>
  <td><pre>
NameVirtualHost 127.0.0.1

&lt;VirtualHost 192.168.1.5>
    ServerAdmin root@localhost
    DocumentRoot /var/www/obm/php
    ServerName obm-panthere
    ErrorLog /var/log/apache/obm-error.log
    CustomLog /var/log/apache/obm-access.log common
    SetEnv OBM_INCLUDE_VAR obminclude
    Alias /images /var/www/obm/obminclude/themes
    DirectoryIndex obm.php
&lt;/VirtualHost>
</pre>
  </td>
</tr>
</table>


<h2>4: Create the OBM database</h2>

<h3>4.1: OBM configuration</h3>

# in obminclude edit the file <i>obm_conf.inc</i> and select the database to use, declare the database, the database user and password.
You can update some global preferences in this file too (eg: cgp_mail_enabled)

<table bgcolor="#CCCCCC" border="1">
<tr>
  <td><pre>
// Database infos
$obmdb_host = "localhost";
$obmdb_dbtype = "MYSQL"; // (MYSQL || PGSQL)
$obmdb_db = "obm";
$obmdb_user = "obm";
$obmdb_password = "obm";

// is Mail enabled ? (agenda)
$gp_mail_enabled = false;
</pre>
  </td>
</tr>
</table>



<h3>4.2: Database Configuration and Creation</h3>
The scripts are in the scripts/0.8 directory.

<h4>4.2.1: Default Data language</h4>

Some references values are inserted by default. These values can be in french (by default) or in english.
To toggle these to english for installation edit the file scripts/0.8/install_obmdb_0.8.mysql.sh (pr pgsql) and change the DATA_LANG value to en :

<table bgcolor="#CCCCCC" border="1">
<tr>
  <td><pre>
# Mysql User, Password and Data lang var definition
U=obm
P="obm"
DB="obm"
DATA_LANG="en"
</pre>
  </td>
</tr>
</table>


<h4>4.2.2: MySQL</h4>

Requisite :</b> you must know (or create) a valid mysql login/password

<p />
mysql user creation example (user obm / obm)
<table bgcolor="#CCCCCC" border="1">
<tr>
  <td><pre>
GRANT CREATE, DROP, SELECT, UPDATE, INSERT, DELETE, LOCK TABLES, INDEX ON obm.* TO obm@localhost IDENTIFIED BY 'obm';
(or simpler GRANT ALL ON obm.* TO obm@localhost IDENTIFIED BY 'obm';)
</pre>
  </td>
</tr>
</table>
<p />

The script <i>install_obmdb_0.8.mysql.sh</i> handle all the database creation steps.
<br>
Set the correct User / password (or DB) in this script and run it
<table bgcolor="#CCCCCC" border="1">
<tr>
  <td><pre>
cd obm/scripts/0.8
emacs /install_obmdb_0.8.mysql.sh
./install_obmdb_0.8.mysql.sh
</pre>
  </td>
</tr>
</table>


<h4>4.2.3: PostgreSQL</h4>

Postgres support is back since 0.7.5.

Create the obm user and create the obm database :
<table bgcolor="#CCCCCC" border="1">
<tr>
  <td><pre>
create user obm password 'obm';
create database obm with owner = obm;
</pre>
  </td>
</tr>
</table>
<p />

<h5>4.2.3.1: For OBM 0.8.0 to 0.8.2</h5>
If your Postgres server is not configured with latin1 character set:
 edit the file scripts/0.8/obmdb_test_values_0.8.sql and scripts/0.8/obmdb_ref_0.8_fr.sql (or scripts/0.8/obmdb_ref_0.8_en.sql for english) and uncomment the lines
<table bgcolor="#CCCCCC" border="1">
<tr>
  <td><pre>
\encoding latin1
</pre>
  </td>
</tr>
</table>
<p />

<h5>4.2.3.2: Since OBM 0.8.3</h5>
If your Postgres server is not configured with latin1 character set:
 edit the file scripts/0.8/postgres-pre.sql and uncomment the line (now uncommented by default)
<table bgcolor="#CCCCCC" border="1">
<tr>
  <td><pre>
\encoding latin1
</pre>
  </td>
</tr>
</table>
<p />

<h5>4.2.3.3: All OBM versions</h5>
The script <i>install_obmdb_0.8.pgsql.sh</i> handle all the database creation steps.
<br>
Edit User / password (or DB) infos in this script and run it
<table bgcolor="#CCCCCC" border="1">
<tr>
  <td><pre>
cd obm/scripts/0.8
emacs install_obmdb_0.8_pgsql.sh
./install_obmdb_0.8_pgsql.sh
</pre>
  </td>
</tr>
</table>


<h2>5: Run OBM (access the obm.php from your browser)</h2>
# First restart your apache web server

<table bgcolor="#CCCCCC" border="1">
<tr>
  <td><pre>
/etc/init.d/apache restart
</pre>
  </td>
</tr>
</table>

<p /># If all goes well run netscape and launch the url
<br />yourvirtualhost/

<P># Log in with the uadmin/padmin account


<p/>
<a name="upgrade-0.8.0"><h1>UPGRADE OBM DATABASE 0.7.5 to 0.8.0 (MySQL)</h1></a>
<p />
# MySQL Database has evolved from 0.7.5 to 0.8.0
<table bgcolor="#CCCCCC" border="1">
<tr>
  <td><pre>
mysql -u obm -pobm obm < scripts/0.8/update-0.7.5-0.8.0.mysql.sql
</pre>
  </td>
</tr>
</table>

<p />
# As a consequence of the new db model, some data need an update too.
<table bgcolor="#CCCCCC" border="1">
<tr>
  <td><pre>
cd scripts/0.8
php4 update-0.7.5-0.8.0.php  (on Debian)
php update-0.7.5-0.8.0.php  (on Redhat)
</pre>
  </td>
</tr>
</table>

<p />
# Insert new default preferences values and propagate them to users (see <a href="#upgrade-common">common upgrade actions</a>).


<p />
<a name="upgrade-0.8.1"><h1>UPGRADE OBM DATABASE 0.8.0 to 0.8.1 (MySQL and Postgres)</h1></a>
<p />
# MySQL Database has evolved from 0.8.0 to 0.8.1
<table bgcolor="#CCCCCC" border="1">
<tr>
  <td><pre>
mysql -u obm -pobm obm < scripts/0.8/update-0.8.0-0.8.1.mysql.sql
</pre>
  </td>
</tr>
</table>

# Postgres Database has evolved from 0.8.0 to 0.8.1
<table bgcolor="#CCCCCC" border="1">
<tr>
  <td><pre>
psql -U obm obm < scripts/0.8/update-0.8.0-0.8.1.pgsql.sql
</pre>
  </td>
</tr>
</table>

<p />
# Insert new default preferences values and propagate them to users (see <a href="#upgrade-common">common upgrade actions</a>).


<p />
<a name="upgrade-0.8.2"><h1>UPGRADE OBM DATABASE 0.8.1 to 0.8.2 (MySQL and Postgres)</h1></a>
<p />
# MySQL Database has evolved from 0.8.1 to 0.8.2
<table bgcolor="#CCCCCC" border="1">
<tr>
  <td><pre>
mysql -u obm -pobm obm < scripts/0.8/update-0.8.1-0.8.2.mysql.sql
</pre>
  </td>
</tr>
</table>

# Postgres Database has evolved from 0.8.1 to 0.8.2
<table bgcolor="#CCCCCC" border="1">
<tr>
  <td><pre>
psql -U obm obm < scripts/0.8/update-0.8.1-0.8.2.pgsql.sql
</pre>
  </td>
</tr>
</table>


<p />
<a name="upgrade-0.8.3"><h1>UPGRADE OBM DATABASE 0.8.2 to 0.8.3 (MySQL and Postgres)</h1></a>
<p />
# MySQL Database has evolved from 0.8.2 to 0.8.3
<table bgcolor="#CCCCCC" border="1">
<tr>
  <td><pre>
mysql -u obm -pobm obm < scripts/0.8/update-0.8.2-0.8.3.mysql.sql
</pre>
  </td>
</tr>
</table>

# Postgres Database has evolved from 0.8.2 to 0.8.3
<table bgcolor="#CCCCCC" border="1">
<tr>
  <td><pre>
psql -U obm obm < scripts/0.8/update-0.8.2-0.8.3.pgsql.sql
</pre>
  </td>
</tr>
</table>

<p />
# Insert new default preferences values and propagate them to users (see <a href="#upgrade-common">common upgrade actions</a>).


<p />
<a name="upgrade-0.8.4"><h1>UPGRADE OBM DATABASE 0.8.3 to 0.8.4 (MySQL and Postgres)</h1></a>
<p />
# MySQL Database has evolved from 0.8.3 to 0.8.4
<table bgcolor="#CCCCCC" border="1">
<tr>
  <td><pre>
mysql -u obm -pobm obm < scripts/0.8/update-0.8.3-0.8.4.mysql.sql
</pre>
  </td>
</tr>
</table>

# Postgres Database has evolved from 0.8.3 to 0.8.4
<table bgcolor="#CCCCCC" border="1">
<tr>
  <td><pre>
psql -U obm obm < scripts/0.8/update-0.8.3-0.8.4.pgsql.sql
</pre>
  </td>
</tr>
</table>

<p />
# Insert new default preferences values and propagate them to users (see <a href="#upgrade-common">common upgrade actions</a>).


<p />
<a name="upgrade-0.8.5"><h1>UPGRADE OBM DATABASE 0.8.4 to 0.8.5 (MySQL and Postgres)</h1></a>
<p />
# MySQL Database has evolved from 0.8.4 to 0.8.5
<table bgcolor="#CCCCCC" border="1">
<tr>
  <td><pre>
mysql -u obm -pobm obm < scripts/0.8/update-0.8.4-0.8.5.mysql.sql
</pre>
  </td>
</tr>
</table>

# Postgres Database has evolved from 0.8.4 to 0.8.5
<table bgcolor="#CCCCCC" border="1">
<tr>
  <td><pre>
psql -U obm obm < scripts/0.8/update-0.8.4-0.8.5.pgsql.sql
</pre>
  </td>
</tr>
</table>

<p />
# Insert new default preferences values and propagate them to users (see <a href="#upgrade-common">common upgrade actions</a>).

<p />
# Update store values for List module (see <a href="#upgrade-common">common upgrade actions</a>).


<p />
<a name="upgrade-0.8.6"><h1>UPGRADE OBM DATABASE 0.8.5 to 0.8.6 (MySQL and Postgres)</h1></a>
<p />
# MySQL Database has evolved from 0.8.5 to 0.8.6 (beware, update script <b>requires MySQL 4.x</b> and does not work with MySQL 3.23 ! Check your mysql version before upgrading)
<table bgcolor="#CCCCCC" border="1">
<tr>
  <td><pre>
mysql -u obm -pobm obm < scripts/0.8/update-0.8.5-0.8.6.mysql.sql
</pre>
  </td>
</tr>
</table>

# Postgres Database has evolved from 0.8.5 to 0.8.6
<table bgcolor="#CCCCCC" border="1">
<tr>
  <td><pre>
psql -U obm obm < scripts/0.8/update-0.8.5-0.8.6.pgsql.sql
</pre>
  </td>
</tr>
</table>

<p />
# Insert new default preferences values and propagate them to users (see <a href="#upgrade-common">common upgrade actions</a>).

<p />
# Update store values for List module (see <a href="#upgrade-common">common upgrade actions</a>).


<p />
<a name="upgrade-0.8.7"><h1>UPGRADE OBM FROM 0.8.6 to 0.8.7</h1></a>
<p />
OBM Database hasn't evolved from 0.8.6 to 0.8.7, so no update scripts are needed.

<p />
# Insert new default preferences values and propagate them to users (see <a href="#upgrade-common">common upgrade actions</a>).

<p />
# Update store values for List module (see <a href="#upgrade-common">common upgrade actions</a>).



<p />
<a name="upgrade-common"><h1>UPGRADE COMMON ACTIONS</h1></a>

<h3>Insert new default preferences values</h3>
# MySQL
<table bgcolor="#CCCCCC" border="1">
<tr>
  <td><pre>
mysql -u obm -pobm obm < scripts/0.8/obmdb_default_values_0.8.sql
</pre>
  </td>
</tr>
</table>
<p>
# Postgres
<table bgcolor="#CCCCCC" border="1">
<tr>
  <td><pre>
psql -U obm obm < scripts/0.8/obmdb_default_values_0.8.sql
</pre>
  </td>
</tr>
</table>

<h3>Propagate new default display values for each user</h3>
# In OBM, from the ADMINISTRATION section (must be connected with an admin user), go to the <b>Prefs</b> (or Préférences) module and execute the action <b>user_pref_update</b> (which reload defaut preferences for each user)

<p>
<h3>Update stored values that are not calculated</h3>
# In OBM, from the ADMINISTRATION section (must be connected with an admin user), go to the <b>Data</b> module and execute the action <b>data_update</b> for the selected module (company, deal, list or document) which update these values.


<h3>Insert NAF code values</h3>
A naf code dump is available (french naf codes). If you want to insert these reference data :
# MySQL Naf code data
<table bgcolor="#CCCCCC" border="1">
<tr>
  <td><pre>
mysql -u obm -pobm obm < scripts/0.8/obmdb_nafcode_0.8_fr.sql
</pre>
  </td>
</tr>
</table>

# Postgres Naf code data
<table bgcolor="#CCCCCC" border="1">
<tr>
  <td><pre>
psql -U obm obm < scripts/0.8/obmdb_nafcode_0.8_fr.sql
</pre>
  </td>
</tr>
</table>


<br /><br />
<a href="javascript:back();">back</a>


</body>
</html>
